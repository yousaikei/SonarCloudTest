steps:
  # 1ï¸âƒ£ SonarCloud æ‰«æ
  - id: sonar_scan
    name: 'sonarsource/sonar-scanner-cli:latest'
    entrypoint: sh
    args:
      - '-c'
      - |
        sonar-scanner \
          -Dsonar.projectKey=SonarCloudTest \
          -Dsonar.organization=yousaikei \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=$SONAR_TOKEN

  # 2ï¸âƒ£ å‘ GitHub PR è¯„è®º
  - id: sonar_comment
    name: 'alpine:3.18'
    entrypoint: sh
    args:
      - '-c'
      - |
        set -e
        SONAR_PROJECT_KEY=SonarCloudTest
        REPO_FULL_NAME=yousaikei/SonarCloudTest
        COMMIT_SHA=$SHORT_SHA

        # è·å– Quality Gate çŠ¶æ€
        STATUS=$(curl -s -u $SONAR_TOKEN: \
          "https://sonarcloud.io/api/qualitygates/project_status?projectKey=$SONAR_PROJECT_KEY" | jq -r '.projectStatus.status')

        # PR Numberï¼ˆPoCå¯æ‰‹åŠ¨å¡«å†™æˆ–ä» webhook payload è·å–ï¼‰
        PR_NUMBER=1

        # å‘è¯„è®º
        curl -s -X POST -H "Authorization: token $GITHUB_PAT" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/$REPO_FULL_NAME/issues/$PR_NUMBER/comments \
          -d "{\"body\":\"ğŸ” SonarCloud Quality Gate: **$STATUS** â†’ [See Report](https://sonarcloud.io/dashboard?id=$SONAR_PROJECT_KEY)\"}"

substitutions:
  _SONAR_TOKEN: $SONAR_TOKEN
  _GITHUB_PAT: $GITHUB_PAT

